{% extends "event/form_base.html" %}

{% block head_extends %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" type="text/css" href="{{ static('event/styles/css/select2.css') }}" />

<style>

</style>
{% endblock %}

{% block form_title %}Application{% endblock %}
{% block form_attrs %}enctype="multipart/form-data"{% endblock %}

{% set form_action=url("registration:application") %}

{% block form_inputs %}
    {% for field in form %}
        {% if field.field.widget.input_type == "select" %}
            {{ render_field(field, size="s12 select2-wrapper") }}
        {% elif field.field.widget.input_type == "file" %}
            {{ render_field(field, size="s12", show_label=False) }}
        {% elif field.field.widget.input_type == "checkbox" %}
            {{ render_checkbox_field(field, size="s12") }}
        {% else %}
            {{ render_field(field, size="s12") }}
        {% endif %}
    {% endfor %}

    {% if form.non_field_errors %}
        {% for error in form.non_field_errors() %}
            {{ error }}
        {% endfor %}
    {% endif %}
{% endblock %}

{% block form_button %}
<div class="input-field col s12">
    <button type="submit" class="btn-small waves-effect waves-light secondaryColor colorBtn center">Submit</button>
</div>
{% endblock %}

{% block form_bottom %}
<div class="row center">
    Something wrong? <a href="#" class="primaryText hoverLink">Contact us</a>.
</div>
{% endblock %}

{% block scripts %}
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
    const selects = $("select");
    selects.not(".select2-school-select").select2();
    $(".select2-school-select").select2({tags: true});  // Allow custom options for school

    // Properly style any pre-filled selects
    $.each(selects, (i, e) => {
        if (e.value) {
            $(e).siblings("label").addClass("label-active");
        }
    });

    selects.on("select2:opening", function () {
        $(this).siblings("label").addClass("label-active");
    });
    selects.on("select2:closing", function () {
        if (!this.value) {
            $(this).siblings("label").removeClass("label-active");
        }
    })
});

$.get("https://raw.githubusercontent.com/MLH/mlh-policies/master/schools.csv", (data) => {
    /* Populate the school list with MLH's list of recognized schools.
    *  Because `tags: true` is set, applicants can enter a custom option as well. */
    let schools = data.split("\n").slice(1);
    let select2Data = [];

    for (let school of schools) {
        school = school.trim().replace(/["]/g, "");
        select2Data.push({
           id: school,
           text: school
        });
    }

    let select2Elem = $(".select2-school-select");

    let select2 = select2Elem.select2({
        data: select2Data,
        tags: true,
    });

    select2.data('select2').$selection.css('height', '2.4375rem');

    {% if form.school.value() and form.school.value() is not none %}
    /* Since school is actually a text field rendered with a select
    *  widget, we can't easily set previously selected values from the widget.
    *  Instead, we can force the option to be selected via JS, adding it if
    *  necessary. */
    const selectedSchool = "{{ form.school.value() }}";

    if (select2Elem.find(`option[value='${selectedSchool}']`).length) {
        select2Elem.val(selectedSchool).trigger("change");
    } else {
        const newOption = new Option(selectedSchool, selectedSchool, true, true);
        select2Elem.append(newOption).trigger("change");
    }

    select2Elem.siblings("label").addClass("label-active");
    {% endif %}
});
</script>
{% endblock %}
